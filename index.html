<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحديد موقعك بدقة عالية جدًا</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body, html { margin:0; padding:0; height:100%; font-family: bold 18px Arial; }
        #map { width:100%; height:100%; }
        .info {
            position: absolute;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #0f0;
            padding: 15px 30px;
            border-radius: 20px;
            z-index: 10000;
            text-align: center;
            box-shadow: 0 0 30px #0f0;
            min-width: 300px;
        }
        .glow { text-shadow: 0 0 15px #0f0; }
        .acc { color:#ff0; font-size:22px; margin:10px 0; }
        button {
            margin-top:15px;
            padding:14px 35px;
            font-size:20px;
            background:#00ff00;
            color:#000;
            border:none;
            border-radius:50px;
            cursor:pointer;
            font-weight:bold;
        }
    </style>
</head>
<body>

<div class="info" id="status">
    <div class="glow">جاري طلب إذن تحديد الموقع...</div>
    <div class="acc" id="accuracy"></div>
    <div id="coords"></div>
    <button onclick="startLocation()">إعادة تحديد الموقع</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([24.7136, 46.6753], 6);
    L.tileLayer('https://{s.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker, circle;

    function startLocation() {
        document.getElementById('status').innerHTML = 
            '<div class="glow">جاري طلب إذن تحديد الموقع...</div>';

        if (!navigator.geolocation) {
            document.getElementById('status').innerHTML = 
                '<div style="color:red">المتصفح لا يدعم تحديد الموقع</div>';
            return;
        }

        // هذا السطر هو اللي بيطلّع السؤال الرسمي للمتصفح فورًا
        navigator.geolocation.getCurrentPosition(onSuccess, onError, {
            enableHighAccuracy: true,   // GPS + Wi-Fi + أبراج الجوال
            timeout: 20000,
            maximumAge: 0
        });
    }

    function onSuccess(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const acc = position.coords.accuracy;

        document.getElementById('accuracy').text').innerHTML = `الدقة: ±${acc.toFixed(0)} متر`;
        document.getElementById('coords').innerHTML = 
            `${lat.toFixed(7)}<br>${lng.toFixed(7)}`;

        document.getElementById('status').innerHTML = 
            = `<div class="glow">تم تحديد موقعك بدقة عالية!</div>
               <div class="acc">الدقة: ±${acc.toFixed(0)} متر</div>
               <div>${lat.toFixed(7)}<br>${lng.toFixed(7)}</div>
               <button onclick="startLocation()">تحديث الموقع</button>`;

        map.setView([lat, lng], 18);

        if (marker) map.removeLayer(marker);
        if (circle) map.removeLayer(circle);

        marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`<b>أنت هنا!</b><br>دقة: ±${acc.toFixed(0)} م<br>
            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">فتح في جوجل مابس</a>`)
            .openPopup();

        circle = L.circle([lat, lng], {
            color: '#00ff00',
            fillColor: '#00ff00',
            fillOpacity: 0.2,
            radius: acc
        }).addTo(map);
    }

    function onError(err) {
        let msg = "خطأ غير معروف";
        if (err.code === 1) msg = "تم رفض إذن الموقع<br>↩️ افتح الإعدادات ← الخصوصية ← الموقع ← اسمح لهذا الموقع";
        if (err.code === 2) msg = "تعذر تحديد الموقع (جرب مكان مفتوح)";
        if (err.code === 3) msg = "انتهت المهلة.. أعد المحاولة";

        document.getElementById('status').innerHTML = 
            `<div style="color:#f66">${msg}</div>
             <button onclick="startLocation()">إعادة المحاولة</button>`;
    }

    // أهم سطر: يشتغل فور فتح الصفحة ويطلع السؤال الرسمي للمتصفح
    window.onload = startLocation;
</script>
</body>
</html>
